<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç’°èˆˆ - ç•°å‘³èˆ‡æ¡æ¨£ç›£æ¸¬åœ–</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        body { margin: 0; padding: 0; font-family: "Microsoft JhengHei", sans-serif; }
        #map { height: 100vh; width: 100vw; }
        
        .instruction {
            position: absolute; top: 20px; left: 50%; transform: translateX(-50%);
            z-index: 1000; background: rgba(255, 255, 255, 0.9);
            padding: 10px 20px; border-radius: 25px; font-weight: bold; pointer-events: none;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2); border: 1px solid #ccc;
        }

        /* --- æ¨™ç±¤å®¹å™¨ --- */
        .marker-badge {
            position: relative;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background-color: white;
            border-radius: 12px;
            padding: 5px 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            white-space: nowrap;
            transform: translate(-50%, -100%);
            margin-top: -10px; 
        }

        /* å°–è§’ */
        .marker-badge::after {
            content: ''; position: absolute; bottom: -11px; left: 50%; transform: translateX(-50%);
            width: 0; height: 0; border-left: 8px solid transparent; border-right: 8px solid transparent;
        }

        /* --- 1. æ°‘çœ¾é€šå ±æ¨£å¼ --- */
        .skull-style { border: 2px solid #333; }
        .skull-style::after { border-top: 10px solid #333; }

        /* --- 2. è˜‡ç‘ªç½æ¨£å¼ (å¼·åŒ–é‡‘å±¬æ„Ÿ) --- */
        .canister-style { 
            border: 2px solid #546e7a; 
            background: linear-gradient(135deg, #ffffff 0%, #e1f5fe 100%);
        }
        .canister-style::after { border-top: 10px solid #546e7a; }
        
        .canister-svg {
            width: 28px; height: 32px;
            margin-right: 8px;
            display: flex; align-items: center;
        }
        .canister-label { color: #263238; font-weight: 800; font-size: 15px; }

        .skull-icon-text { font-size: 22px; line-height: 1; }
        .crosshair-icon { font-size: 34px; color: #ff0000; text-shadow: 0 0 4px white; display: flex; justify-content: center; }
        
        /* å½ˆçª— */
        .report-form { padding: 5px; min-width: 180px; }
        .report-form select, .report-form button { width: 100%; margin-top: 8px; padding: 8px; border-radius: 4px; }
        .report-form button { background: #333; color: white; border: none; font-weight: bold; cursor: pointer; }
        
        .custom-marker-container { width: 0 !important; height: 0 !important; }
    </style>
</head>
<body>

    <div class="instruction">ğŸ“ ç’°èˆˆ - ç•°å‘³é€šå ±èˆ‡æ¡æ¨£ç›£æ¸¬ç³»çµ±</div>
    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, getDocs } 
               from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAHrh_ygy_4NKI8xYEssvOGkeMF--W4mjU",
            authDomain: "odor--explore.firebaseapp.com",
            projectId: "odor--explore",
            storageBucket: "odor--explore.firebasestorage.app",
            messagingSenderId: "50345839778",
            appId: "1:50345839778:web:9d144849e4bb3667efdbfb"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // åˆå§‹åŒ–åœ°åœ– (é è¨­ç¸®æ”¾è‡³å°ç£ç¯„åœ)
        const map = L.map('map').setView([25.0330, 121.5654], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap'
        }).addTo(map);

        // --- è˜‡ç‘ªç½ SVG åœ–ç¤º ---
        const summaCanisterSvg = `
            <svg viewBox="0 0 40 45" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M10 5 Q20 2 30 5" stroke="#90a4ae" stroke-width="2" fill="none"/>
                <line x1="10" y1="5" x2="10" y2="20" stroke="#b0bec5" stroke-width="1.5"/>
                <line x1="30" y1="5" x2="30" y2="20" stroke="#b0bec5" stroke-width="1.5"/>
                <circle cx="20" cy="12" r="4" fill="#00bcd4" stroke="#00838f" stroke-width="1"/>
                <rect x="19" y="16" width="2" height="6" fill="#78909c"/>
                <circle cx="20" cy="30" r="12" fill="url(#metalGradient)" stroke="#546e7a" stroke-width="1"/>
                <defs>
                    <linearGradient id="metalGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" style="stop-color:#eceff1" />
                        <stop offset="50%" style="stop-color:#b0bec5" />
                        <stop offset="100%" style="stop-color:#78909c" />
                    </linearGradient>
                </defs>
            </svg>
        `;

        // è®€å– Firebase æ¡æ¨£ç½è³‡æ–™ (ä¿®æ­£æŠ“å– doc.id)
        async function loadCanisters() {
            try {
                const querySnapshot = await getDocs(collection(db, "canisters"));
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    const canisterId = doc.id; // é€™è£¡æœƒæŠ“åˆ° can1, can2

                    if (data.lat && data.lng) {
                        const icon = L.divIcon({
                            className: 'custom-marker-container',
                            html: `
                                <div class="marker-badge canister-style">
                                    <div class="canister-svg">${summaCanisterSvg}</div>
                                    <span class="canister-label">${canisterId}</span>
                                </div>`,
                            iconSize: null, iconAnchor: [0, 0]
                        });
                        
                        L.marker([data.lat, data.lng], { icon: icon }).addTo(map)
                         .bindPopup(`<b>ç©ºæ±¡ç›£æ¸¬è¨­å‚™</b><br>ç·¨è™Ÿï¼š${canisterId}<br>è¨­å‚™ï¼šSumma Canister`);
                    }
                });
            } catch (e) { 
                console.error("è³‡æ–™åŠ è¼‰å¤±æ•—ï¼š", e); 
            }
        }
        loadCanisters();

        // å³æ™‚ç›£è½æ°‘çœ¾ç•°å‘³é€šå ±
        onSnapshot(query(collection(db, "smell_reports"), orderBy("timestamp", "asc")), (snapshot) => {
            snapshot.docChanges().forEach((change) => {
                if (change.type === "added") {
                    const data = change.doc.data();
                    let skulls = '';
                    for(let i=0; i<data.level; i++) skulls += 'ğŸ’€';
                    const icon = L.divIcon({
                        className: 'custom-marker-container',
                        html: `<div class="marker-badge skull-style"><span class="skull-icon-text">${skulls}</span></div>`,
                        iconSize: null, iconAnchor: [0, 0]
                    });
                    L.marker([data.lat, data.lng], { icon: icon }).addTo(map)
                     .bindPopup(`<b>${data.type}</b><br>ç¨‹åº¦: ${data.level} ğŸ’€<br>æ™‚é–“: ${data.timestamp?.toDate().toLocaleString() || 'æœªçŸ¥'}`);
                }
            });
        });

        // åœ°åœ–é»æ“Šï¼šæ–°å¢é€šå ±
        let tempMarker = null;
        map.on('click', (e) => {
            const { lat, lng } = e.latlng;
            if (tempMarker) map.removeLayer(tempMarker);
            
            tempMarker = L.marker([lat, lng], { 
                icon: L.divIcon({ 
                    className:'custom-crosshair', 
                    html:'<div class="crosshair-icon">âŠ•</div>', 
                    iconSize:[30,30], 
                    iconAnchor:[15,15] 
                }) 
            }).addTo(map);

            tempMarker.bindPopup(`
                <div class="report-form">
                    <strong>ğŸ“ æ–°å¢ç•°å‘³é€šå ±</strong>
                    <select id="popType">
                        <option value="å¡‘è† ç„¦å‘³">å¡‘è† ç„¦å‘³</option>
                        <option value="è…æ•—é…¸è‡­">è…æ•—é…¸è‡­</option>
                        <option value="åŒ–å­¸è—¥åŠ‘">åŒ–å­¸è—¥åŠ‘</option>
                        <option value="æ²¹ç…™ç•°å‘³">æ²¹ç…™ç•°å‘³</option>
                    </select>
                    <select id="popLevel">
                        <option value="1">1 ğŸ’€ (è¼•å¾®)</option>
                        <option value="2">2 ğŸ’€ğŸ’€ (æ˜é¡¯)</option>
                        <option value="3">3 ğŸ’€ğŸ’€ğŸ’€ (æ¥µè‡­)</option>
                    </select>
                    <button id="submitBtn">é€å‡ºé€šå ±</button>
                </div>`).openPopup();

            // è™•ç†æŒ‰éˆ•é»æ“Šäº‹ä»¶
            setTimeout(() => {
                const btn = document.getElementById('submitBtn');
                if (btn) {
                    btn.onclick = async () => {
                        try {
                            await addDoc(collection(db, "smell_reports"), {
                                lat, lng, 
                                type: document.getElementById('popType').value,
                                level: parseInt(document.getElementById('popLevel').value),
                                timestamp: new Date()
                            });
                            map.removeLayer(tempMarker);
                            alert("é€šå ±å·²é€å‡ºï¼");
                        } catch (err) {
                            alert("é€å‡ºå¤±æ•—ï¼Œè«‹æª¢æŸ¥æ¬Šé™è¨­å®š");
                        }
                    };
                }
            }, 100);
        });

        // ç²å–ä½¿ç”¨è€…ç•¶å‰ä½ç½®
        map.locate({setView: true, maxZoom: 15});
    </script>
</body>
</html>