<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç•°å‘³è¿½è¹¤ - æ­·å²ç´€éŒ„å­˜å„²ç‰ˆ</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        body { margin: 0; padding: 0; font-family: "Microsoft JhengHei", sans-serif; }
        #map { height: 100vh; width: 100vw; }
        
        .instruction {
            position: absolute; top: 20px; left: 50%; transform: translateX(-50%);
            z-index: 1000; background: rgba(255, 255, 255, 0.9);
            padding: 10px 20px; border-radius: 25px; font-weight: bold; pointer-events: none;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        /* éª·é«é ­åœ–ç¤º */
        .skull-container { display: flex; white-space: nowrap; filter: drop-shadow(0 0 1px black); }
        .skull-icon { font-size: 24px; color: transparent; -webkit-text-stroke: 1px black; margin-right: 2px; }

        /* é¸é»åå­—æº–å¿ƒ */
        .crosshair-icon { font-size: 30px; color: red; font-weight: bold; display: flex; justify-content: center; align-items: center; }

        .report-form { padding: 5px; min-width: 180px; }
        .report-form select, .report-form button { width: 100%; margin-top: 10px; padding: 8px; border-radius: 4px; }
        .report-form button { background: black; color: white; border: none; cursor: pointer; font-weight: bold; }
        
        /* å½ˆçª—å…§çš„æ™‚é–“æ¨£å¼ */
        .report-time { font-size: 11px; color: #666; margin-top: 5px; border-top: 1px dashed #ccc; padding-top: 5px; }
    </style>
</head>
<body>

    <div class="instruction">ğŸ“ é»æ“Šåœ°åœ–é¸ä½ï¼Œè³‡æ–™å°‡æ°¸ä¹…å„²å­˜æ–¼é›²ç«¯</div>
    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy } 
               from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // âš ï¸ è«‹å‹™å¿…å¡«å…¥ä½ çš„ Firebase é…ç½®
        const firebaseConfig = {
            apiKey: "AIzaSyAHrh_ygy_4NKI8xYEssvOGkeMF--W4mjU",
            authDomain: "odor--explore.firebaseapp.com",
            databaseURL: "https://odor--explore-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "odor--explore",
            storageBucket: "odor--explore.firebasestorage.app",
            messagingSenderId: "50345839778",
            appId: "1:50345839778:web:9d144849e4bb3667efdbfb",
            measurementId: "G-XJSZYW23S6"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const map = L.map('map').setView([25.0330, 121.5654], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap'
        }).addTo(map);

        let tempMarker = null;

        // --- é»æ“Šåœ°åœ–ï¼šé¡¯ç¤ºåå­—æº–å¿ƒ ---
        map.on('click', function(e) {
            const { lat, lng } = e.latlng;
            if (tempMarker) map.removeLayer(tempMarker);

            const crosshair = L.divIcon({
                className: 'custom-crosshair',
                html: `<div class="crosshair-icon">âŠ•</div>`,
                iconSize: [30, 30], iconAnchor: [15, 15]
            });

            tempMarker = L.marker([lat, lng], { icon: crosshair }).addTo(map);
            
            const formHtml = `
                <div class="report-form">
                    <strong>é€šå ±ç•°å‘³ä½ç½®</strong>
                    <select id="popType">
                        <option value="å¡‘è† ç„¦å‘³">å¡‘è† ç„¦å‘³</option>
                        <option value="è…æ•—é…¸è‡­">è…æ•—é…¸è‡­</option>
                        <option value="å·¥æ¥­å»¢æ°£">å·¥æ¥­å»¢æ°£</option>
                    </select>
                    <select id="popLevel">
                        <option value="1">1 ğŸ’€ (è¼•å¾®)</option>
                        <option value="2">2 ğŸ’€ğŸ’€ (æ˜é¡¯)</option>
                        <option value="3">3 ğŸ’€ğŸ’€ğŸ’€ (æ¥µè‡­)</option>
                    </select>
                    <button id="submitBtn">æ­£å¼é€šå ±ä¸¦å„²å­˜</button>
                </div>
            `;
            tempMarker.bindPopup(formHtml).openPopup();

            setTimeout(() => {
                const btn = document.getElementById('submitBtn');
                if(btn) {
                    btn.onclick = () => {
                        const type = document.getElementById('popType').value;
                        const level = parseInt(document.getElementById('popLevel').value);
                        sendData(lat, lng, type, level);
                    };
                }
            }, 100);
        });

        // --- å°‡è³‡æ–™å¯«å…¥é›²ç«¯ (æ°¸ä¹…å„²å­˜) ---
        async function sendData(lat, lng, type, level) {
            try {
                await addDoc(collection(db, "smell_reports"), {
                    lat, lng, type, level,
                    timestamp: new Date() // é€™è£¡å„²å­˜äº†é€šå ±æ™‚é–“
                });
                map.removeLayer(tempMarker);
                console.log("è³‡æ–™å·²æ°¸ä¹…å„²å­˜è‡³ Firebase");
            } catch (e) {
                alert("å„²å­˜å¤±æ•—ï¼Œè«‹æª¢æŸ¥ Firebase è¨­å®š");
            }
        }

        // --- æ ¸å¿ƒï¼šå¾é›²ç«¯è®€å–ã€Œæ‰€æœ‰ã€æ­·å²è³‡æ–™ ---
        // ä½¿ç”¨ onSnapshot ä»£è¡¨åªè¦è³‡æ–™åº«æœ‰è®Šå‹•ï¼Œæˆ–è€…é‡æ–°æ•´ç†ç¶²é ï¼Œéƒ½æœƒåŸ·è¡Œé€™è£¡
        onSnapshot(query(collection(db, "smell_reports"), orderBy("timestamp", "asc")), (snapshot) => {
            snapshot.docChanges().forEach((change) => {
                if (change.type === "added") {
                    const data = change.doc.data();
                    
                    // æ ¼å¼åŒ–æ™‚é–“é¡¯ç¤º
                    const reportDate = data.timestamp ? new Date(data.timestamp.seconds * 1000).toLocaleString() : "æœªçŸ¥æ™‚é–“";
                    
                    let skullsHtml = '';
                    for(let i=0; i<data.level; i++) {
                        skullsHtml += '<span class="skull-icon">ğŸ’€</span>';
                    }

                    const skullIcon = L.divIcon({
                        className: 'custom-skull-marker',
                        html: `<div class="star-container">${skullsHtml}</div>`,
                        iconSize: [80, 40], iconAnchor: [20, 20]
                    });

                    L.marker([data.lat, data.lng], { icon: skullIcon })
                     .addTo(map)
                     .bindPopup(`
                        <b>${data.type}</b><br>
                        åš´é‡ç¨‹åº¦: ${data.level}<br>
                        <div class="report-time">é€šå ±æ™‚é–“ï¼š<br>${reportDate}</div>
                     `);
                }
            });
        });

        map.locate({setView: true, maxZoom: 16});
    </script>
</body>
</html>