<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç’°èˆˆ - ç•°å‘³é€šå ±ç¶²é æ¸¬è©¦ç‰ˆ</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        body { margin: 0; padding: 0; font-family: "Microsoft JhengHei", sans-serif; }
        #map { height: 100vh; width: 100vw; }
        
        .instruction {
            position: absolute; top: 20px; left: 50%; transform: translateX(-50%);
            z-index: 1000; background: rgba(255, 255, 255, 0.9);
            padding: 10px 20px; border-radius: 25px; font-weight: bold; pointer-events: none;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2); border: 1px solid #ccc;
        }

        /* --- æ ¸å¿ƒä¿®æ”¹ï¼šè‡ªé©æ‡‰å¯¬åº¦çš„éª·é«é ­å¾½ç«  --- */
        .skull-badge {
            position: relative;
            display: inline-flex; /* é—œéµï¼šè®“å®¹å™¨éš¨å…§å®¹é•·åº¦ä¼¸ç¸® */
            align-items: center;
            justify-content: center;
            background-color: white;
            border: 2px solid black;
            border-radius: 10px;
            padding: 4px 8px; /* å…§è·ç¢ºä¿ 1 é¡†æˆ– 3 é¡†æ™‚éƒ½æœ‰å‘¼å¸ç©ºé–“ */
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            white-space: nowrap;
            /* é—œéµå®šä½ï¼š
               1. translate(-50%, -100%)ï¼šè®“æ¨™ç±¤æ°´å¹³ç½®ä¸­ï¼Œä¸”åº•éƒ¨ä½æ–¼åº§æ¨™é»
               2. margin-topï¼šçµ¦ä¸‹æ–¹çš„å°–è§’é ç•™é¡¯ç¤ºç©ºé–“ 
            */
            transform: translate(-50%, -100%);
            margin-top: -10px; 
        }

        /* å°–è§’å¤–æ¡† */
        .skull-badge::after {
            content: '';
            position: absolute;
            bottom: -11px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 8px solid transparent;
            border-right: 8px solid transparent;
            border-top: 10px solid black;
        }

        /* å°–è§’ç™½è‰²å¡«å…… */
        .skull-badge::before {
            content: '';
            position: absolute;
            bottom: -8px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1;
            width: 0;
            height: 0;
            border-left: 7px solid transparent;
            border-right: 7px solid transparent;
            border-top: 9px solid white;
        }

        .skull-text {
            font-size: 24px;
            line-height: 1;
            margin: 0 1px;
            z-index: 2;
        }

        /* åå­—æº–å¿ƒæ¨£å¼ */
        .crosshair-icon { 
            font-size: 34px; color: #ff0000; font-weight: bold; 
            text-shadow: 0 0 4px white, 0 0 4px white; 
            display: flex; justify-content: center; align-items: center;
        }

        /* å½ˆçª—æ¨£å¼ */
        .report-form { padding: 5px; min-width: 180px; }
        .report-form select, .report-form button { width: 100%; margin-top: 10px; padding: 8px; border-radius: 4px; }
        .report-form button { background: black; color: white; border: none; cursor: pointer; font-weight: bold; }
        .report-time { font-size: 11px; color: #666; margin-top: 8px; border-top: 1px dashed #ccc; padding-top: 5px; }
        
        /* ç§»é™¤ Leaflet é è¨­å®¹å™¨é™åˆ¶ï¼Œè®“ CSS æ§åˆ¶å¤§å° */
        .custom-skull-marker { width: 0 !important; height: 0 !important; }
    </style>
</head>
<body>

    <div class="instruction">ğŸ“ ç’°èˆˆ - ç•°å‘³é€šå ±ç¶²é æ¸¬è©¦ç‰ˆ</div>
    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy } 
               from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAHrh_ygy_4NKI8xYEssvOGkeMF--W4mjU",
            authDomain: "odor--explore.firebaseapp.com",
            databaseURL: "https://odor--explore-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "odor--explore",
            storageBucket: "odor--explore.firebasestorage.app",
            messagingSenderId: "50345839778",
            appId: "1:50345839778:web:9d144849e4bb3667efdbfb",
            measurementId: "G-XJSZYW23S6"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const map = L.map('map').setView([25.0330, 121.5654], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap'
        }).addTo(map);

        let tempMarker = null;

        map.on('click', function(e) {
            const { lat, lng } = e.latlng;
            if (tempMarker) map.removeLayer(tempMarker);

            const crosshair = L.divIcon({
                className: 'custom-crosshair',
                html: `<div class="crosshair-icon">âŠ•</div>`,
                iconSize: [30, 30], iconAnchor: [15, 15]
            });

            tempMarker = L.marker([lat, lng], { icon: crosshair }).addTo(map);
            
            const formHtml = `
                <div class="report-form">
                    <strong>é€šå ±æ­¤è™•ç•°å‘³</strong>
                    <select id="popType">
                        <option value="å¡‘è† ç„¦å‘³">å¡‘è† ç„¦å‘³</option>
                        <option value="è…æ•—é…¸è‡­">è…æ•—é…¸è‡­</option>
                        <option value="å·¥æ¥­å»¢æ°£">å·¥æ¥­å»¢æ°£</option>
                    </select>
                    <select id="popLevel">
                        <option value="1">1 ğŸ’€ (è¼•å¾®)</option>
                        <option value="2">2 ğŸ’€ğŸ’€ (æ˜é¡¯)</option>
                        <option value="3">3 ğŸ’€ğŸ’€ğŸ’€ (æ¥µè‡­)</option>
                    </select>
                    <button id="submitBtn">é€å‡ºé€šå ±</button>
                </div>
            `;
            tempMarker.bindPopup(formHtml).openPopup();

            setTimeout(() => {
                const btn = document.getElementById('submitBtn');
                if(btn) {
                    btn.onclick = () => {
                        const type = document.getElementById('popType').value;
                        const level = parseInt(document.getElementById('popLevel').value);
                        sendData(lat, lng, type, level);
                    };
                }
            }, 100);
        });

        async function sendData(lat, lng, type, level) {
            try {
                await addDoc(collection(db, "smell_reports"), {
                    lat, lng, type, level, timestamp: new Date()
                });
                map.removeLayer(tempMarker);
            } catch (e) {
                alert("é€šå ±å¤±æ•—");
            }
        }

        // --- æ ¸å¿ƒï¼šæ¸²æŸ“éš¨å…§å®¹ä¼¸ç¸®çš„æ¨™ç±¤ ---
        onSnapshot(query(collection(db, "smell_reports"), orderBy("timestamp", "asc")), (snapshot) => {
            snapshot.docChanges().forEach((change) => {
                if (change.type === "added") {
                    const data = change.doc.data();
                    const reportDate = data.timestamp ? new Date(data.timestamp.seconds * 1000).toLocaleString() : "æœªçŸ¥æ™‚é–“";
                    
                    let skullsHtml = '';
                    for(let i=0; i<data.level; i++) {
                        skullsHtml += '<span class="skull-text">ğŸ’€</span>';
                    }

                    const skullIcon = L.divIcon({
                        className: 'custom-skull-marker', // è¨­ç‚ºç©ºæ®¼ï¼Œç”±å…§å±¤ CSS æ§åˆ¶
                        html: `<div class="skull-badge">${skullsHtml}</div>`,
                        iconSize: null,   // ä¸é™åˆ¶å¤§å°
                        iconAnchor: [0, 0] // éŒ¨é»ç”± CSS çš„ transform: translate(-50%, -100%) è™•ç†
                    });

                    L.marker([data.lat, data.lng], { icon: skullIcon })
                     .addTo(map)
                     .bindPopup(`
                        <b>${data.type}</b><br>
                        åš´é‡ç¨‹åº¦: ${data.level} ğŸ’€<br>
                        <div class="report-time">é€šå ±æ™‚é–“ï¼š<br>${reportDate}</div>
                     `);
                }
            });
        });

        map.locate({setView: true, maxZoom: 16});
    </script>
</body>
</html>