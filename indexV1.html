<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç•°å‘³è¿½è¹¤ - ç²¾ç¢ºåœ°åœ–é‡˜ç‰ˆ</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        body { margin: 0; padding: 0; font-family: "Microsoft JhengHei", sans-serif; }
        #map { height: 100vh; width: 100vw; }
        
        .instruction {
            position: absolute; top: 20px; left: 50%; transform: translateX(-50%);
            z-index: 1000; background: rgba(255, 255, 255, 0.9);
            padding: 10px 20px; border-radius: 25px; font-weight: bold; pointer-events: none;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2); border: 1px solid #ccc;
        }

        /* --- æ ¸å¿ƒä¿®æ”¹ï¼šå¸¶å°–è§’çš„éª·é«é ­å¾½ç«  --- */
        .skull-badge {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: white;
            border: 2px solid black;
            border-radius: 12px; /* ç¨å¾®æ¸›å°åœ“è§’ï¼Œæ›´æœ‰æ°£æ³¡æ„Ÿ */
            padding: 4px 10px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            white-space: nowrap;
        }

        /* ä¸‹æ–¹çš„æŒ‡å‘å°–è§’ */
        .skull-badge::after {
            content: '';
            position: absolute;
            bottom: -10px; /* è®“å°–è§’çªå‡ºåº•éƒ¨ */
            left: 50%;
            transform: translateX(-50%);
            /* è£½ä½œä¸‰è§’å½¢ */
            width: 0;
            height: 0;
            border-left: 8px solid transparent;
            border-right: 8px solid transparent;
            border-top: 10px solid black; /* é€™æ˜¯å°–è§’çš„é»‘è‰²å¤–æ¡† */
        }

        /* å°–è§’å…§éƒ¨çš„ç™½è‰²å¡«å…… (ç‚ºäº†é®æ‰é»‘æ¡†çš„ä¸€éƒ¨åˆ†ï¼Œè®“å®ƒçœ‹èµ·ä¾†æ˜¯é€£ç‚ºä¸€é«”çš„) */
        .skull-badge::before {
            content: '';
            position: absolute;
            bottom: -7px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1;
            width: 0;
            height: 0;
            border-left: 7px solid transparent;
            border-right: 7px solid transparent;
            border-top: 9px solid white;
        }

        .skull-text {
            font-size: 24px;
            line-height: 1;
            margin: 0 2px;
            z-index: 2; /* ç¢ºä¿éª·é«é ­åœ¨æœ€ä¸Šå±¤ */
        }

        /* é¸é»åå­—æº–å¿ƒ */
        .crosshair-icon { 
            font-size: 34px; color: #ff0000; font-weight: bold; 
            text-shadow: 0 0 4px white, 0 0 4px white; 
            display: flex; justify-content: center; align-items: center;
        }

        .report-form { padding: 5px; min-width: 180px; }
        .report-form select, .report-form button { width: 100%; margin-top: 10px; padding: 8px; border-radius: 4px; }
        .report-form button { background: black; color: white; border: none; cursor: pointer; font-weight: bold; }
        .report-time { font-size: 11px; color: #666; margin-top: 8px; border-top: 1px dashed #ccc; padding-top: 5px; }
    </style>
</head>
<body>

    <div class="instruction">ğŸ“ é»æ“Šä½ç½®å³å¯ç²¾ç¢ºé€šå ±</div>
    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy } 
               from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // ä¿ç•™ä½ æä¾›çš„ Firebase é…ç½®
        const firebaseConfig = {
            apiKey: "AIzaSyAHrh_ygy_4NKI8xYEssvOGkeMF--W4mjU",
            authDomain: "odor--explore.firebaseapp.com",
            databaseURL: "https://odor--explore-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "odor--explore",
            storageBucket: "odor--explore.firebasestorage.app",
            messagingSenderId: "50345839778",
            appId: "1:50345839778:web:9d144849e4bb3667efdbfb",
            measurementId: "G-XJSZYW23S6"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const map = L.map('map').setView([25.0330, 121.5654], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap'
        }).addTo(map);

        let tempMarker = null;

        map.on('click', function(e) {
            const { lat, lng } = e.latlng;
            if (tempMarker) map.removeLayer(tempMarker);

            const crosshair = L.divIcon({
                className: 'custom-crosshair',
                html: `<div class="crosshair-icon">âŠ•</div>`,
                iconSize: [30, 30], iconAnchor: [15, 15]
            });

            tempMarker = L.marker([lat, lng], { icon: crosshair }).addTo(map);
            
            const formHtml = `
                <div class="report-form">
                    <strong>åœ¨æ­¤é€šå ±ç•°å‘³</strong>
                    <select id="popType">
                        <option value="å¡‘è† ç„¦å‘³">å¡‘è† ç„¦å‘³</option>
                        <option value="è…æ•—é…¸è‡­">è…æ•—é…¸è‡­</option>
                        <option value="å·¥æ¥­å»¢æ°£">å·¥æ¥­å»¢æ°£</option>
                    </select>
                    <select id="popLevel">
                        <option value="1">1 ğŸ’€</option>
                        <option value="2">2 ğŸ’€ğŸ’€</option>
                        <option value="3">3 ğŸ’€ğŸ’€ğŸ’€</option>
                    </select>
                    <button id="submitBtn">é€å‡ºé€šå ±</button>
                </div>
            `;
            tempMarker.bindPopup(formHtml).openPopup();

            setTimeout(() => {
                const btn = document.getElementById('submitBtn');
                if(btn) {
                    btn.onclick = () => {
                        const type = document.getElementById('popType').value;
                        const level = parseInt(document.getElementById('popLevel').value);
                        sendData(lat, lng, type, level);
                    };
                }
            }, 100);
        });

        async function sendData(lat, lng, type, level) {
            try {
                await addDoc(collection(db, "smell_reports"), {
                    lat, lng, type, level, timestamp: new Date()
                });
                map.removeLayer(tempMarker);
            } catch (e) {
                alert("å„²å­˜å¤±æ•—");
            }
        }

        // --- æ ¸å¿ƒï¼šæ¸²æŸ“å¸¶å°–è§’çš„éª·é«é ­åœ°åœ–é‡˜ ---
        onSnapshot(query(collection(db, "smell_reports"), orderBy("timestamp", "asc")), (snapshot) => {
            snapshot.docChanges().forEach((change) => {
                if (change.type === "added") {
                    const data = change.doc.data();
                    const reportDate = data.timestamp ? new Date(data.timestamp.seconds * 1000).toLocaleString() : "æœªçŸ¥æ™‚é–“";
                    
                    let skullsHtml = '';
                    for(let i=0; i<data.level; i++) {
                        skullsHtml += '<span class="skull-text">ğŸ’€</span>';
                    }

                    const skullIcon = L.divIcon({
                        className: 'custom-skull-marker',
                        html: `<div class="skull-badge">${skullsHtml}</div>`,
                        iconSize: [100, 50], 
                        // é‡è¦ï¼šèª¿æ•´ iconAnchorï¼Œè®“å°–è§’çš„æœ€åº•ç«¯å°æº–åº§æ¨™
                        // [å¯¬åº¦çš„ä¸€åŠ, ç¸½é«˜åº¦(åŒ…å«å°–è§’)]
                        iconAnchor: [50, 48] 
                    });

                    L.marker([data.lat, data.lng], { icon: skullIcon })
                     .addTo(map)
                     .bindPopup(`
                        <b>${data.type}</b><br>
                        åš´é‡ç¨‹åº¦: ${data.level} ğŸ’€<br>
                        <div class="report-time">é€šå ±æ™‚é–“ï¼š<br>${reportDate}</div>
                     `);
                }
            });
        });

        map.locate({setView: true, maxZoom: 16});
    </script>
</body>
</html>